#+options: ^:nil
* Basic Arch Install
#+begin_src bash
dhcpcd

timedatectl set-ntp true


fdisk /dev/sda 

# Create 300MB boot, 2GB swap, and leave the rest for root

mkswp /dev/sda2

mkfs.ext4 /dev/sda3

mount /dev/sda3 /mnt

swapon /dev/sda2

# edit /etc/pacman.d/mirrorlist to change mirror order **

pacstrap /mnt base

genfstab -p /mnt >> /mnt/etc/fstab

arch-chroot /mnt

ln -s /usr/share/zoneinfo/America/Indianapolis /etc/localtime

hwclock --systohc --utc

# uncomment en_US locales in /etc/locale.gen **

locale-gen

# enter hostname in /etc/hostname **

mkinitcpio -p linux

passwd

grub-install --target=i386-pc --recheck --debug /dev/sda

grub-mkconfig -o /boot/grub/grub.cfg

exit

reboot

pacman -S vim htop git

pacman -S xorg-server xf86-video-ati xorg-xinit
#+end_src

* Generic Linux Install
#+begin_src bash
# Copy bootable image to flash drive (status=progress requires dd >= 8.24)
dd if=foobar.iso if=/dev/sdX status=progress && sync
#+end_src

* iptables
** Commands
#+begin_src bash
# list all tables
iptables -L -n -v
# (fedora) save iptables rules and remember to disable firewalld
iptables-save > /etc/sysconfig/iptables
#+end_src
* LXC
** Config examples
*/etc/lxc/lxc.conf* - set path for containers to be stored (default /var/lib/lxc)
#+begin_src bash
lxc.lxcpath = "/lxc"
#+end_src

*/lxc/container_name/config*
#+begin_src bash
lxc.network.type = veth
lxc.network.link = virbr0
lxc.network.hwaddr = fe:0e:86:4b:b4:c0
lxc.network.flags = up
lxc.rootfs = /dev/fedora/container_name
lxc.rootfs.backend = lvm

# Include common configuration
lxc.include = /usr/share/lxc/config/fedora.common.conf

lxc.arch = x86_64
lxc.utsname = container_name
#+end_src

*iptables config*
#+begin_src bash
sudo iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT
iptables -t nat -A POSTROUTING -o enp6s0f0 -j MASQUERADE

### PLUG ###
iptables -I FORWARD -m state -d 192.168.1.100/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT
#webserver
iptables -t nat -I PREROUTING -p tcp --dport 10080 -j DNAT --to-destination 192.168.1.100:80
#ssh
iptables -t nat -I PREROUTING -p tcp --dport 10022 -j DNAT --to-destination 192.168.1.100:22
#irc
iptables -t nat -I PREROUTING -p tcp --dport 8001 -j DNAT --to-destination 192.168.1.100:8001
#minetest
iptables -t nat -I PREROUTING -p udp --dport 30000 -j DNAT --to-destination 192.168.1.100:30000
#poop
iptables -t nat -I PREROUTING -p udp --dport 2301 -j DNAT --to-destination 192.168.1.100:2301
iptables -t nat -I PREROUTING -p udp --dport 2303 -j DNAT --to-destination 192.168.1.100:2303
iptables -t nat -I PREROUTING -p udp --dport 23682 -j DNAT --to-destination 192.168.1.100:23682

### John ###

iptables -I FORWARD -m state -d 192.168.1.101/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT
#webserver
iptables -t nat -I PREROUTING -p tcp --dport 10180 -j DNAT --to-destination 192.168.1.101:80
#ssh
iptables -t nat -I PREROUTING -p tcp --dport 10122 -j DNAT --to-destination 192.168.1.101:22
#mosh
iptables -t nat -I PREROUTING -p udp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
iptables -t nat -I PREROUTING -p tcp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001

### cannon ###
iptables -I FORWARD -m state -d 192.168.1.103/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT
#ssh
iptables -t nat -I PREROUTING -p tcp --dport 10322 -j DNAT --to-destination 192.168.1.103:22

### evan ###
iptables -I FORWARD -m state -d 192.168.1.104/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT
#ssh
iptables -t nat -I PREROUTING -p tcp --dport 10422 -j DNAT --to-destination 192.168.1.104:22
iptables -t nat -I PREROUTING -p tcp --dport 64738 -j DNAT --to-destination 192.168.1.104:64738

### epics ###
iptables -I FORWARD -m state -d 192.168.1.105/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT
#ssh
iptables -t nat -I PREROUTING -p tcp --dport 10522 -j DNAT --to-destination 192.168.1.105:22
#+end_src

*/etc/sysconfig/iptables* (generated by iptables-save)
#+begin_src bash
# Generated by iptables-save v1.4.21 on Thu Sep  1 13:36:16 2016
*nat
:PREROUTING ACCEPT [8:799]
:INPUT ACCEPT [6:679]
:OUTPUT ACCEPT [1:56]
:POSTROUTING ACCEPT [1:60]
-A PREROUTING -p tcp -m tcp --dport 10522 -j DNAT --to-destination 192.168.1.105:22
-A PREROUTING -p tcp -m tcp --dport 64738 -j DNAT --to-destination 192.168.1.104:64738
-A PREROUTING -p tcp -m tcp --dport 10422 -j DNAT --to-destination 192.168.1.104:22
-A PREROUTING -p tcp -m tcp --dport 10322 -j DNAT --to-destination 192.168.1.103:22
-A PREROUTING -p tcp -m tcp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p udp -m udp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p tcp -m tcp --dport 10122 -j DNAT --to-destination 192.168.1.101:22
-A PREROUTING -p tcp -m tcp --dport 10180 -j DNAT --to-destination 192.168.1.101:80
-A PREROUTING -p udp -m udp --dport 23682 -j DNAT --to-destination 192.168.1.100:23682
-A PREROUTING -p udp -m udp --dport 2303 -j DNAT --to-destination 192.168.1.100:2303
-A PREROUTING -p udp -m udp --dport 2301 -j DNAT --to-destination 192.168.1.100:2301
-A PREROUTING -p udp -m udp --dport 30000 -j DNAT --to-destination 192.168.1.100:30000
-A PREROUTING -p tcp -m tcp --dport 8001 -j DNAT --to-destination 192.168.1.100:8001
-A PREROUTING -p tcp -m tcp --dport 10022 -j DNAT --to-destination 192.168.1.100:22
-A PREROUTING -p tcp -m tcp --dport 10080 -j DNAT --to-destination 192.168.1.100:80
-A PREROUTING -p tcp -m tcp --dport 10522 -j DNAT --to-destination 192.168.1.105:22
-A PREROUTING -p tcp -m tcp --dport 64738 -j DNAT --to-destination 192.168.1.104:64738
-A PREROUTING -p tcp -m tcp --dport 10422 -j DNAT --to-destination 192.168.1.104:22
-A PREROUTING -p tcp -m tcp --dport 10322 -j DNAT --to-destination 192.168.1.103:22
-A PREROUTING -p tcp -m tcp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p udp -m udp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p tcp -m tcp --dport 10122 -j DNAT --to-destination 192.168.1.101:22
-A PREROUTING -p tcp -m tcp --dport 10180 -j DNAT --to-destination 192.168.1.101:80
-A PREROUTING -p udp -m udp --dport 23682 -j DNAT --to-destination 192.168.1.100:23682
-A PREROUTING -p udp -m udp --dport 2303 -j DNAT --to-destination 192.168.1.100:2303
-A PREROUTING -p udp -m udp --dport 2301 -j DNAT --to-destination 192.168.1.100:2301
-A PREROUTING -p udp -m udp --dport 30000 -j DNAT --to-destination 192.168.1.100:30000
-A PREROUTING -p tcp -m tcp --dport 8001 -j DNAT --to-destination 192.168.1.100:8001
-A PREROUTING -p tcp -m tcp --dport 10022 -j DNAT --to-destination 192.168.1.100:22
-A PREROUTING -p tcp -m tcp --dport 10080 -j DNAT --to-destination 192.168.1.100:80
-A PREROUTING -p tcp -m tcp --dport 10522 -j DNAT --to-destination 192.168.1.105:22
-A PREROUTING -p tcp -m tcp --dport 64738 -j DNAT --to-destination 192.168.1.104:64738
-A PREROUTING -p tcp -m tcp --dport 10422 -j DNAT --to-destination 192.168.1.104:22
-A PREROUTING -p tcp -m tcp --dport 10322 -j DNAT --to-destination 192.168.1.103:22
-A PREROUTING -p tcp -m tcp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p udp -m udp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p tcp -m tcp --dport 10122 -j DNAT --to-destination 192.168.1.101:22
-A PREROUTING -p tcp -m tcp --dport 10180 -j DNAT --to-destination 192.168.1.101:80
-A PREROUTING -p udp -m udp --dport 23682 -j DNAT --to-destination 192.168.1.100:23682
-A PREROUTING -p udp -m udp --dport 2303 -j DNAT --to-destination 192.168.1.100:2303
-A PREROUTING -p udp -m udp --dport 2301 -j DNAT --to-destination 192.168.1.100:2301
-A PREROUTING -p udp -m udp --dport 30000 -j DNAT --to-destination 192.168.1.100:30000
-A PREROUTING -p tcp -m tcp --dport 8001 -j DNAT --to-destination 192.168.1.100:8001
-A PREROUTING -p tcp -m tcp --dport 10022 -j DNAT --to-destination 192.168.1.100:22
-A PREROUTING -p tcp -m tcp --dport 10080 -j DNAT --to-destination 192.168.1.100:80
-A PREROUTING -p tcp -m tcp --dport 10522 -j DNAT --to-destination 192.168.1.105:22
-A PREROUTING -p tcp -m tcp --dport 64738 -j DNAT --to-destination 192.168.1.104:64738
-A PREROUTING -p tcp -m tcp --dport 10422 -j DNAT --to-destination 192.168.1.104:22
-A PREROUTING -p tcp -m tcp --dport 10322 -j DNAT --to-destination 192.168.1.103:22
-A PREROUTING -p tcp -m tcp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p udp -m udp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p tcp -m tcp --dport 10122 -j DNAT --to-destination 192.168.1.101:22
-A PREROUTING -p tcp -m tcp --dport 10180 -j DNAT --to-destination 192.168.1.101:80
-A PREROUTING -p udp -m udp --dport 23682 -j DNAT --to-destination 192.168.1.100:23682
-A PREROUTING -p udp -m udp --dport 2303 -j DNAT --to-destination 192.168.1.100:2303
-A PREROUTING -p udp -m udp --dport 2301 -j DNAT --to-destination 192.168.1.100:2301
-A PREROUTING -p udp -m udp --dport 30000 -j DNAT --to-destination 192.168.1.100:30000
-A PREROUTING -p tcp -m tcp --dport 8001 -j DNAT --to-destination 192.168.1.100:8001
-A PREROUTING -p tcp -m tcp --dport 10022 -j DNAT --to-destination 192.168.1.100:22
-A PREROUTING -p tcp -m tcp --dport 10080 -j DNAT --to-destination 192.168.1.100:80
-A PREROUTING -p tcp -m tcp --dport 10522 -j DNAT --to-destination 192.168.1.105:22
-A PREROUTING -p tcp -m tcp --dport 64738 -j DNAT --to-destination 192.168.1.104:64738
-A PREROUTING -p tcp -m tcp --dport 10422 -j DNAT --to-destination 192.168.1.104:22
-A PREROUTING -p tcp -m tcp --dport 10322 -j DNAT --to-destination 192.168.1.103:22
-A PREROUTING -p tcp -m tcp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p udp -m udp --dport 60001 -j DNAT --to-destination 192.168.1.101:60001
-A PREROUTING -p tcp -m tcp --dport 10122 -j DNAT --to-destination 192.168.1.101:22
-A PREROUTING -p tcp -m tcp --dport 10180 -j DNAT --to-destination 192.168.1.101:80
-A PREROUTING -p udp -m udp --dport 23682 -j DNAT --to-destination 192.168.1.100:23682
-A PREROUTING -p udp -m udp --dport 2303 -j DNAT --to-destination 192.168.1.100:2303
-A PREROUTING -p udp -m udp --dport 2301 -j DNAT --to-destination 192.168.1.100:2301
-A PREROUTING -p udp -m udp --dport 30000 -j DNAT --to-destination 192.168.1.100:30000
-A PREROUTING -p tcp -m tcp --dport 8001 -j DNAT --to-destination 192.168.1.100:8001
-A PREROUTING -p tcp -m tcp --dport 10022 -j DNAT --to-destination 192.168.1.100:22
-A PREROUTING -p tcp -m tcp --dport 10080 -j DNAT --to-destination 192.168.1.100:80
-A POSTROUTING -o enp6s0f0 -j MASQUERADE
-A POSTROUTING -o enp6s0f0 -j MASQUERADE
-A POSTROUTING -o enp6s0f0 -j MASQUERADE
COMMIT
# Completed on Thu Sep  1 13:36:16 2016
# Generated by iptables-save v1.4.21 on Thu Sep  1 13:36:16 2016
*filter
:INPUT ACCEPT [93:6878]
:FORWARD ACCEPT [42:5487]
:OUTPUT ACCEPT [57:7040]
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A FORWARD -d 192.168.1.0/24 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 192.168.1.0/24 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 192.168.1.0/24 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 192.168.1.0/24 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -d 192.168.1.0/24 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Thu Sep  1 13:36:16 2016
 
#+end_src
** Commands
#+begin_src bash
# list container statuses and ip addresses (fancy mode)
lxc-ls -f
#+end_src

#+begin_src bash
brctl show
brctl delbr virbr0
brctl addbr virbr0
ip link set virbr0 down
#+end_src

#+begin_src bash
# set libvirtd ip range
virsh net-edit default
virsh -c lxc:/// net-define /etc/libvirt/qemu/networks/default.xml
virsh -c lsc:/// net-start default
virsh -c lsc:/// net-autostart default
#+end_src

* Weechat
#+begin_src bash
# enable notifications for any messages in buffer (works for Android client, too)
/buffer set highlight_regex .\ast{}.*
#+end_src
* MDADM
#+begin_src bash
# check RAID state
cat /proc/mdstat  # look for failure, (F), after the drive name: sda1[0](F)

# simulate a failed drive
mdadm --manage --set-faulty /dev/md/pv00 /dev/sda1

# remove faulty state by removing and readding
mdadm --remove /dev/md/pv00 /dev/sda1
mdadm --add /dev/md/pv00 /dev/sda1
#+end_src


* Auto FS
Auto FS + SSHFS allows the system to mount ssh filesystems on access and then automatically unmount after a certain timeout.  The necessary tools are *autofs* and *sshfs*.

*/etc/auto.master* or */etc/auto.master.d/foobar.autofs* or */etc/autofs/auto.master*
#+begin_src bash
# mounts all the entries listed in /etc/auto.sshfs in /mnt/ with the given options
/mnt /etc/auto.sshfs --timeout=180 --ghost --verbose
#+end_src

*/etc/auto.sshfs*
#+begin-src bash
# make a mount to be used by auto.master
foobar -fstype=fuse,rw,IdentityFile=/home/evan/.ssh/foobar,port=22,allow_other :sshfs\#foo@example.org\:
#+end_src
